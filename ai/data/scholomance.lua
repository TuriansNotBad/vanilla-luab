
import 'ai/common_encounter.lua'

t_dungeons[289] = {
	-- Line 1 LHS reliquary
	{
		{200.991, 107.302, 128.437, -1000, 2}, -- 1
		{201.715, 53.0746, 128.776, -1000, 2}, -- 2
		{234.039, 46.7492, 115.708, -1000, 2}, -- 3
		{211.349, -4.61522, 115.709, -1000, 2}, -- 4
	},
	-- Line 2 RHS reliquary
	{
		{200.991, 107.302, 128.437, -1000, 2}, -- 1
		{194.507, 51.6821, 128.866, -1000, 2}, -- 2
		{166.794, 45.4331, 115.708, -1000, 2}, -- 3
		{192.622, -5.61731, 115.708, -1000, 2}, -- 4
	},
	-- Line 3 Reliquary - Ossuary basement
	{
		{262.382, 46.986, 115.725, -1000, 2}, -- 1
		{259.033, 146.134, 109.76, -1000, 2}, -- 2
		{167.781, 153.415, 109.5, -1000, 2}, -- 3
		{88.4079, 152.22, 109.409, -1000, 2}, -- 4
		{63.873, 153.962, 101.996, -1000, 2}, -- 5
		{65.254, 177.219, 102.025, -1000, 2}, -- 6
		{96.4893, 181.098, 93.0852, -1000, 2}, -- 7
		{151.932, 145.96, 93.1727, -1000, 2}, -- 8
	},
	-- Line 4 Blood boss room
	{
		{291.412, 93.4628, 109.973, -1000, 2}, -- 1
		{320.928, 94.1871, 101.639, -1000, 2}, -- 2
	},
	-- Line 5 Summoning bottom room RHS
	{
		{210.184, 196.854, 109.839, -1000, 2}, -- 1
		{240.246, 189.627, 95.8452, -1000, 2}, -- 2
		{241.114, 170.947, 95.8235, -1000, 2}, -- 3
		{229.657, 155.367, 95.8235, -1000, 2}, -- 4
		{233.971, 99.2144, 95.8235, -1000, 2}, -- 5
		{249.369, 92.9149, 95.8235, -1000, 2}, -- 6
	},
	-- Line 6 Summoning bottom room LHS
	{
		{244.142, 193.725, 95.8455, -1000, 2}, -- 1
		{243.614, 171.62, 95.8237, -1000, 2}, -- 2
		{278.983, 160.552, 95.8237, -1000, 2}, -- 3
		{278.221, 98.0791, 95.8237, -1000, 2}, -- 4
		{268.607, 87.2137, 95.829, -1000, 2}, -- 5
		{268.401, 68.852, 95.8398, -1000, 2}, -- 6
	},
	-- Line 7 Viewing room - Laboratory
	{
		{228.120, 130.395, 109.640, -1000, 2}, -- 1
		{199.532, 127.768, 109.795, -1000, 2}, -- 2
		{200.699, 87.7751, 104.244, -1000, 2}, -- 3
		{174.204, 74.1138, 104.715, -1000, 2}, -- 4
		{145.31, 75.0517, 103.526, -1000, 2}, -- 5
		{83.3116, 101.343, 97.4868, -1000, 2}, -- 6
		{67.8318, 140.6, 83.4974, -1000, 2}, -- 7
		{47.4542, 143.981, 83.5456, -1000, 2}, -- 8
		{-46.4908, 145.655, 83.5456, -1000, 2}, -- 9
	},
	-- Line 8 Viewing room - Lorekeeper
	{
		{136.895, 45.2653, 102.742, -1000, 2}, -- 1
		{175.403, 38.3758, 88.7522, -1000, 2}, -- 2
		{182.248, 23.7167, 88.8796, -1000, 2}, -- 3
		{202.339, 21.5554, 89.0232, -1000, 2}, -- 4
		{206.041, 1.37682, 88.9806, -1000, 2}, -- 5
		{272.279, 1.3572, 85.2282, -1000, 2}, -- 6
	},
	-- Line 9 Headmaster's Study - Instructor
	{
		{157.6, 23.2478, 88.9797, -1000, 2}, -- 1
		{154.515, 0.553414, 88.9736, -1000, 2}, -- 2
		{144.382, -0.474674, 88.9525, -1000, 2}, -- 3
		{90.319, -4.07535, 85.2283, -1000, 2}, -- 5
	},
	-- Line 10 Headmaster's Study - Doctor
	{
		{158.587, -24.6282, 88.9831, -1000, 2}, -- 1
		{179.613, -25.3989, 88.9867, -1000, 2}, -- 2
		{181.329, -37.148, 88.9525, -1000, 2}, -- 3
		{182.846, -92.4663, 85.2283, -1000, 2}, -- 5
	},
	-- Line 11 Headmaster's Study - Alexei
	{
		{179.898, 18.4054, 88.3433, -1000, 2}, -- 1
		{179.941, 1.79917, 75.4798, -1000, 2}, -- 2
		{179.588, -46.9755, 75.3978, -1000, 2}, -- 3
		{170.225, -68.8949, 75.3964, -1000, 2}, -- 4
		{171.979, -78.8853, 70.7734, -1000, 2}, -- 5
		{181.153, -91.0914, 70.7734, -1000, 2}, -- 6
	},
	-- Line 12 Headmaster's Study - Ravenian
	{
		{169.359, 12.701, 75.561, -1000, 2}, -- 1
		{161.396, -1.57743, 75.5578, -1000, 2}, -- 2
		{106.28, -0.850208, 75.3672, -1000, 2}, -- 3
	},
	-- Line 13 Headmaster's Study - Illucia
	{
		{190.583, 12.904, 75.528, -1000, 2}, -- 1
		{199.331, 0.552805, 75.5569, -1000, 2}, -- 2
		{261.992, 0.91307, 75.25, -1000, 2}, -- 3
	},
};

local Scholomance = t_dungeons[289];

Scholomance.Global = {
	key = "Scholomance.Global.OldRole",
	StudentDoorPos = {135.851,58.3541,102.732},
};

local _losTbl = Encounter_MakeLOSTbl()
	-- Reliquary
	.new 'WoodenBridge' {201.136, 66.7120, 128.435} {207.278, 98.9230, 128.435}
	.new 'ReliqLHStair' {216.437, 45.4665, 125.230} {208.050, 51.9520, 128.768}
	.new 'ReliqRHStair' {185.714, 45.1888, 123.930} {195.080, 48.0054, 128.828}
	-- Summoning Room
	.new 'SummonRoomLH' {243.379, 37.5020, 115.708} {231.981, 48.1201, 115.708}
	.new 'SummonRoomRH' {243.379, 37.5020, 115.708} {231.981, 48.1201, 115.708}
	-- Big Open Room
	.new 'BigOREntranc' {246.591, 113.859, 109.973} {242.230, 92.6634, 109.973}
	.new 'BigORMidNook' {192.894, 193.913, 109.837} {203.967, 200.049, 109.837}
	-- Laboratory
	.new 'ViewingRoomC' {192.676, 98.8923, 104.713} {211.930, 99.0164, 104.714}
	.new 'ViewingRoomF' {150.590, 48.0029, 100.845} {152.356, 38.5822, 99.7902}
	.new 'LaboratoryRM' {70.6319, 118.034, 93.4038} {79.0490, 107.260, 97.4858}
	-- Final Room
	.new 'FinalRoomIns' {155.077, 9.56055, 88.9931} {201.907, 24.0542, 88.9976}
.endtbl();

local _areaTbl = Encounter_MakeAreaTbl(_losTbl)
	-- Reliquary
	.new ('EntLeftStair', SHAPE_POLYGON) {231.061, 55.8251} {244.757, 56.1598} {244.249, 29.0245} {231.261, 29.0245} ('WoodenBridge', 115.709, 20)
	.new ('ReliquaryLHS', SHAPE_POLYGON) {198.724, -23.243} {197.677, 42.0430} {244.630, 37.9132} {245.466, -23.243} ('ReliqLHStair', 115.709, 20)
	.new ('ReliquaryRHS', SHAPE_POLYGON) {198.724, -23.243} {197.677, 42.0430} {158.469, 40.8208} {158.215, -23.243} ('ReliqRHStair', 115.709, 20)
	-- Summoning Room
	.new ('SummonRoomLH', SHAPE_POLYGON) {262.287, 68.4254} {261.685, 131.744} {237.687, 134.090} {240.943, 66.9154} ('SummonRoomLH', 109.974, 20)
	.new ('SummonRoomRH', SHAPE_POLYGON) {262.287, 68.4254} {261.685, 131.744} {284.248, 132.027} {285.416, 70.2859} ('SummonRoomRH', 109.974, 20)
	-- Big Open Room
	.new ('BigOREntranc', SHAPE_POLYGON) {225.746, 172.317} {281.000, 168.429} {281.000, 139.312} {227.244, 136.979} ('BigOREntranc', 109.641, 20)
	.new ('BigORMiddle_', SHAPE_POLYGON) {227.497, 109.817} {225.994, 179.824} {199.744, 179.824} {201.307, 109.817} ('BigOREntranc', 109.641, 20)
	.new ('BigORFarPull', SHAPE_POLYGON) {199.744, 179.824} {201.307, 109.817} {167.960, 109.817} {167.123, 179.824} ('BigORMidNook', 109.641, 20)
	-- Laboratory
	.new ('ViewingRoomC', SHAPE_POLYGON) {129.970, 61.6271} {127.162, 120.184} {154.718, 121.937} {156.999, 60.7398} ('ViewingRoomC', 100.361, 50)
	.new ('ViewingRoomF', SHAPE_POLYGON) {156.964, 60.3573} {89.9770, 58.1650} {89.6362, 122.617} {154.718, 121.933} ('ViewingRoomF', 100.361, 50)
	.new ('LaboratoryRM', SHAPE_POLYGON) {56.5319, 121.677} {-49.694, 119.821} {-50.315, 162.150} {55.9244, 164.084} ('LaboratoryRM', 83.5456, 20)
	-- Final Room
	.new ('FinalRoomIns', SHAPE_POLYGON) {134.926, 11.5116} {134.668, -12.981} {90.0395, -13.751} {88.7284, 10.7044} ('FinalRoomIns', 85.2283, 20)
.endtbl();

local NPC_DISEASED_GHOUL        = 10495;
local NPC_REANIMATED_CORPSE     = 10481;
local NPC_PLAGUED_HATCHLING     = 10678;
local NPC_RISEN_LACKEY          = 10482;
local NPC_SPECTRAL_RESEARCHER   = 10499;
local NPC_SCHOLOMANCE_ACOLYTE   = 10471;
local NPC_SCHOLOMANCE_OCCULTIST = 10472;
local NPC_SCHOLOMANCE_STUDENT   = 10475;
local NPC_UNSTABLE_CORPSE       = 10480;
local NPC_SCHOLOMANCE_HANDLER   = 11257;
local NPC_DARK_SHADE            = 11284;
local SPELL_DISEASE_CLOUD       = 17742;
local NPC_RANGED_LIST = Encounter_NewRangedList();

NPC_RANGED_LIST:Register(10469, 10470, NPC_SCHOLOMANCE_OCCULTIST, NPC_SCHOLOMANCE_ACOLYTE, NPC_SCHOLOMANCE_STUDENT, 10476, 10477, 11582);

local function Scholomance_OnLoad(self, hive, data, player)
	
-- Entries
local GO_IRON_GATE      = 175618;
-- final boss gates
local GO_GATE_ILLUCIA   = 177371;
local GO_GATE_POLKELT   = 177376;
local GO_GATE_ALEXEI    = 177373;
local GO_GATE_KRASTINOV = 177377;
local GO_GATE_RAVENIAN  = 177372;
local GO_GATE_MALICIA   = 177375;
	
	Print("Scholomance_OnLoad: initialized by player", player:GetName(), "; Guid:", tostring(player:GetGuid()), player:GetMapId());
	
	-- Find gate near student's room
	local x,y,z,r = Scholomance.Global.StudentDoorPos[1], Scholomance.Global.StudentDoorPos[2], Scholomance.Global.StudentDoorPos[3], 60;
	local doors = GetObjectsWithEntryNear(player, GO_IRON_GATE, x,y,z,r, false);
	if (#doors ~= 1) then
		Print("Error searching for student door around pos = (", x, y, z, ") with radius =", r, "entry =", GO_IRON_GATE, "n =", #doors);
		error("Scholomance_OnLoad: no definitive result found for student's door = " .. tostring(GO_IRON_GATE));
	end
	
	self.Ids.StudentDoor = doors[1];
	
	-- search for final room gates
	x,y,z,r = 181.251,2.65199,75.4789,75.0;
	local t_gateEntries = {
		DoorIllucia   = GO_GATE_ILLUCIA  ,
		DoorPolkelt   = GO_GATE_POLKELT  ,
		DoorAlexei    = GO_GATE_ALEXEI   ,
		DoorKrastinov = GO_GATE_KRASTINOV,
		DoorRavenian  = GO_GATE_RAVENIAN ,
		DoorMalicia   = GO_GATE_MALICIA  ,
	};
	
	for k,entry in next,t_gateEntries do
		
		local gates = GetObjectsWithEntryNear(player, entry, x,y,z,r, false);
		if (#gates ~= 1) then
			Print("Error searching for gate", k, "around pos = (", x, y, z, ") with radius =", r, "entry =", entry, "n =", #gates);
			error("Scholomance_OnLoad: no definitive result found for boss gate = " .. tostring(entry));
		end
		self.Ids[k] = gates[1];
		
	end
	
	
end

function Scholomance.Global:OnBegin(hive, data)
	data.scholoDiseasedGhouls = {};
	Encounter_PreprocessAgents(self.key, data);
end

function Scholomance.Global:OnEnd(hive, data)
	local function restore_agent(ai, agent, aidata, data)
		aidata.targets    = nil;
		aidata.attackmode = nil;
		Data_SetAgentHealModeMax(aidata, nil);
	end
	Encounter_RestoreAgents(self.key, data, restore_agent);
	data.scholoDiseasedGhouls = nil;
end

-- filter out attackers within radius of diseased cloud
local function Scholomance_Global_RemoveCloudedAttackers(attackers, cloud, buffer)
	
	for i = #attackers,1,-1 do
		local target = attackers[i];
		if (target:GetDistance(cloud.x, cloud.y, cloud.z) < cloud.r + buffer) then
			table.remove(attackers, i);
		end
	end
	
end

local t_Scholomance_CcSortInfo = {
	[NPC_SCHOLOMANCE_ACOLYTE]   = true,
	[NPC_SCHOLOMANCE_HANDLER]   = true,
	[NPC_SCHOLOMANCE_OCCULTIST] = true,
};
local function Scholomance_SortCcList(a,b)
	local aCheck = t_Scholomance_CcSortInfo[a:GetEntry()];
	local bCheck = t_Scholomance_CcSortInfo[b:GetEntry()];
	if (aCheck ~= bCheck) then
		return not aCheck;
	end
	
	return a:GetHealth() < b:GetHealth();
end

function Scholomance.Global:UpdatePostAgentProcess(hive, data)
	
	local player = data.owner or (data.agents[1] and data.agents[1]:GetPlayer());
	if (not player) then return; end
	
	-- reset ghouls
	if (#data.attackers == 0) then
		data.scholoDiseasedGhouls = {};
		return;
	end
	
	local tankAI,tank = data:GetFirstActiveTank(true);
	if (tankAI and tankAI:CmdType() ~= CMD_PULL) then
		-- cc list is traversed backwards, hence reverse sort
		data.forcedCc = hive:GetAttackers();
		data.forcedCc.min = 3;
		table.sort(data.forcedCc, Scholomance_SortCcList);
	end
	
	local bHasUnstable      = false;
	local bWatchStudentDoor = false;
	local bNoAttacking      = false;
	local shades = {ignoreThreat = true};
	-- remember ghouls, remove slow enemies, remove enemies feigning death
	for i = #data.attackers,1,-1 do
	
		local target = data.attackers[i];
		local entry = target:GetEntry();
		if (entry == NPC_DISEASED_GHOUL) then
		
			local id = target:GetId();
			if (not data.scholoDiseasedGhouls[id]) then
				data.scholoDiseasedGhouls[id] = target:GetGuid();
			end
			
		elseif (entry == NPC_REANIMATED_CORPSE or entry == NPC_PLAGUED_HATCHLING or entry == NPC_RISEN_LACKEY) then
			-- remove dead or far away reanimated corpses/hatchlings
			if ((target:GetVictim() and target:GetDistance(target:GetVictim()) > 15) or target:GetStandState() == STAND_STATE_DEAD) then
				if (not tankAI or (tankAI:CmdType() ~= CMD_PULL and tankAI:CmdType() ~= CMD_FOLLOW)) then
					table.remove(data.attackers, i);
				end
			end
		
		elseif (entry == NPC_SCHOLOMANCE_OCCULTIST) then
			data.forcedCc.min = 2;
			if (not Unit_IsCrowdControlled(target) and not target:HasAuraType(AURA_SCHOOL_ABSORB)) then
				local _,tankThreat = target:GetHighestThreat();
				if (tankThreat < 1000.0) then
					bNoAttacking = true;
				end
			end
			
		elseif (entry == NPC_DARK_SHADE) then
			table.insert(shades, target);
			if (#data.attackers > 1) then
				table.remove(data.attackers, i);
			end
		
		elseif (entry == NPC_SCHOLOMANCE_STUDENT) then
			-- check if door needs opening
			bWatchStudentDoor = true;
			if (target:HasAuraType(AURA_TRANSFORM)) then
				data.attackers.ignoreThreat = true;
				data.aoe = true;
			end
		
		elseif (entry == NPC_UNSTABLE_CORPSE) then
			bHasUnstable = true;
		end
		
	end
	
	-- open door when near it
	if (tank and bWatchStudentDoor) then
		if (GetObjectGOState(tank, Scholomance.encounters.Ids.StudentDoor) == 1) then
			for i,ai in ipairs(data.agents) do
				local agent = ai:GetPlayer();
				if (agent:GetDistance(self.StudentDoorPos[1], self.StudentDoorPos[2], self.StudentDoorPos[3]) < 7.0) then
					agent:UseObj(Scholomance.encounters.Ids.StudentDoor);
					break;
				end
			end
		end
	end
	
	local bCanReserveCasters = #data.mdps > 0;
	-- handle occultists and shades
	for i,ai in ipairs(data.agents) do
		if (ai:GetRole() ~= ROLE_TANK) then
			local aidata = ai:GetData();
			
			if (ai:GetRole() == ROLE_HEALER) then
				if (bHasUnstable) then
					Data_SetAgentHealModeMax(aidata, true);
				elseif (Data_GetHealModeMax(aidata, data)) then
					Print("Scholomance.Global: reset heal max for", ai:GetPlayer():GetName());
					Data_SetAgentHealModeMax(aidata, nil);
				end
			end
			
			aidata.attackmode = nil;
			-- occultists are too low threat on tank
			if (bNoAttacking) then
				aidata.targets = {};
			else
				
				-- shades found, always attack shades to not spawn more than 1 at a time
				if (#shades > 0) then
					aidata.targets    = shades;
				elseif (aidata.targets) then
					aidata.targets    = nil;
				end
				
				-- reserve casters to not attack, better threat for shade
				local agent = ai:GetPlayer();
				if (bCanReserveCasters and ai:GetRole() == ROLE_RDPS and agent:GetClass() ~= CLASS_HUNTER) then
					local target = agent:GetVictim();
					if (target and target:GetEntry() == NPC_SCHOLOMANCE_OCCULTIST) then
						aidata.attackmode = "none";
					end
				end
				
			end
		end
	end
	
	-- find disease clouds
	for k,ghoulGuid in next,data.scholoDiseasedGhouls do
	
		local ghoul = GetUnitByGuid(player, ghoulGuid);
		if (ghoul) then
		
			local cloud = ghoul:GetPersistentAreaAuraInfo(SPELL_DISEASE_CLOUD);
			if (cloud) then
				
				Scholomance_Global_RemoveCloudedAttackers(data.attackers, cloud, 5.0);
				
			elseif (not ghoul:IsAlive()) then
				-- ghoul doesn't have a cloud, irrelevant
				data.scholoDiseasedGhouls[k] = nil;
			end
			
		else
			-- ghoul doesn't exist
			data.scholoDiseasedGhouls[k] = nil;
		end
		
	end
	
end

--------------------------------------------------------------------
--             Vectus, in case of pull with Marduk
--------------------------------------------------------------------

Scholomance.Vectus = {
	key = "Scholomance.Vectus.OldRole",
};

local NPC_VECTUS = 10432;

function Scholomance.Vectus:OnBegin(hive, data)
	Encounter_PreprocessAgents(self.key, data);
end

function Scholomance.Vectus:OnEnd(hive, data)
	local function restore_agent(ai, agent, aidata, data)
		aidata.defensepot = nil;
		aidata.attackmode = nil;
	end
	Encounter_RestoreAgents(self.key, data, restore_agent);
end

function Scholomance.Vectus:Update(hive, data)
	
	for i,ai in ipairs(data.agents) do
		local aidata = ai:GetData();
		local agent = ai:GetPlayer();
		local role = ai:GetRole();
		if (role == ROLE_RDPS or role == ROLE_HEALER) then
			aidata.defensepot = 17548;
		elseif (role == ROLE_MDPS) then
			aidata.defensepot = 17543;
		end
		if (agent:GetClass() == CLASS_MAGE) then
			if (agent:GetVictim() and agent:GetVictim():GetEntry() == NPC_VECTUS) then
				aidata.attackmode = "fire";
			else
				aidata.attackmode = nil;
			end
		end
	end
	
end

--------------------------------------------------------------------
--                         Kormok
--------------------------------------------------------------------

Scholomance.Kormok = {
	key = "Scholomance.Kormok.OldRole",
};

local NPC_KORMOK = 16118;

function Scholomance.Kormok:OnBegin(hive, data)
	Encounter_PreprocessAgents(self.key, data);
end

function Scholomance.Kormok:OnEnd(hive, data)
	local function restore_agent(ai, agent, aidata, data)
		aidata.targets = nil;
	end
	Encounter_RestoreAgents(self.key, data, restore_agent);
end

function Scholomance.Kormok:Update(hive, data)
	
	local adds = {ignoreThreat = true};
	for i = #data.attackers,1,-1 do
		
		local target = data.attackers[i];
		if (target:GetEntry() ~= NPC_KORMOK) then
			table.remove(data.attackers, i);
			table.insert(adds, target);
		end
		
	end
	
	local n    = 0;
	local nMax = 2;
	for i,ai in ipairs(data.agents) do
		if (ai:GetRole() == ROLE_MDPS or ai:GetRole() == ROLE_RDPS) then
			ai:GetData().targets = adds;
			n = n + 1;
			if (n >= nMax) then break; end
		end
	end
	
end

--------------------------------------------------------------------
--                         Lorekeeper
--------------------------------------------------------------------

Scholomance.Lorekeeper = {
	key = "Scholomance.Lorekeeper.OldRole",
	Isolation = {x = 249.187, y = 11.309, z = 85.228},
	IsolationFromTank = {x = 255.379, y = -11.902, z = 85.228},
};

function Scholomance.Lorekeeper:OnBegin(hive, data)
	local function init_agent(ai, agent, aidata, data)
		if (ai:GetRole() == ROLE_HEALER) then
			Data_SetAgentHealModeMax(aidata, true);
		end
	end
	Encounter_PreprocessAgents(self.key, data, init_agent);
end

function Scholomance.Lorekeeper:OnEnd(hive, data)
	local function restore_agent(ai, agent, aidata, data)
		aidata.rchrpos = nil;
		Data_SetAgentHealModeMax(aidata, nil);
	end
	Encounter_RestoreAgents(self.key, data, restore_agent);
end

function Scholomance.Lorekeeper:Update(hive, data)
	
	-- avoid Volatile Infection
	local tank;
	local bTankDiseased = false;
	local t_diseasedAgents = {};
	for i,ai in ipairs(data.agents) do
	
		local agent = ai:GetPlayer();
		for j,aura in ipairs(agent:GetAurasByTypeTbl(AURA_PERIODIC_TRIGGER_SPELL)) do
			if (not aura.positive and aura.dispel == DISPEL_DISEASE) then
				t_diseasedAgents[i] = true;
				-- tank shouldn't move
				if (ai:CmdType() == CMD_TANK) then
					bTankDiseased = true;
					tank = agent;
				else
					ai:GetData().rchrpos = self.Isolation
				end
				break;
			end
			
		end
		
	end
	
	for i,ai in ipairs(data.agents) do
	
		local agent = ai:GetPlayer();
		if (bTankDiseased and agent:GetDistance(tank) < 15.0) then
			if (ai:CmdType() ~= CMD_TANK) then
				ai:GetData().rchrpos = self.IsolationFromTank;
			end
		
		elseif (not t_diseasedAgents[i]) then
			-- don't run right back to diseased tank if melee dps!
			if (ai:GetRole() ~= ROLE_MDPS or not bTankDiseased) then
				ai:GetData().rchrpos = nil;
			end
		
		end
		
	end
	
end

--------------------------------------------------------------------
--                      Alexei, for healer
--------------------------------------------------------------------

Scholomance.Alexei = {
	key = "Scholomance.Alexei.OldRole",
};

function Scholomance.Alexei:OnBegin(hive, data)
	local function init_agent(ai, agent, aidata, data)
		if (ai:GetRole() == ROLE_HEALER) then
			Data_SetAgentHealModeMax(aidata, true);
		end
	end
	Encounter_PreprocessAgents(self.key, data, init_agent);
end

function Scholomance.Alexei:OnEnd(hive, data)
	local function restore_agent(ai, agent, aidata, data)
		Data_SetAgentHealModeMax(aidata, nil);
	end
	Encounter_RestoreAgents(self.key, data, restore_agent);
end

--------------------------------------------------------------------
--                      Darkmaster Gandling
--------------------------------------------------------------------

Scholomance.Gandling = {
	key = "Scholomance.Gandling.OldRole",
	Rooms = {
		{name="Krastinov Room", 181.293, -65.6213, 84.8408, r=40.0, zr=10.0},
		{name="Polkelt Room",   245.691, 0.586345, 84.8408, r=40.0, zr=10.0},
		{name="Malicia Room",   116.270, -1.54187, 85.3764, r=40.0, zr=10.0},
		{name="Illucia Room",   239.811, 0.467820, 72.6718, r=40.0, zr=10.0},
		{name="Alexei Room",    181.212, -55.3851, 75.3979, r=40.0, zr=10.0},
		{name="Ravenian Room",  124.677, -1.53692, 75.3965, r=40.0, zr=10.0},
		maxZ = 76.0,
	},
	Center = {181.599, -5.5427, 75.4875, r = 10},
	Grenade = {spellid = 19821, cd = 60.0},
};

function Scholomance.Gandling:OnBegin(hive, data)
	Encounter_PreprocessAgents(self.key, data);
end

function Scholomance.Gandling:OnEnd(hive, data)
	local function restore_agent(ai, agent, aidata, data)
		aidata.targets = nil;
		aidata.attackmode = nil;
	end
	data.ScholoGandling_IsAnyAgentHurt = nil;
	Encounter_RestoreAgents(self.key, data, restore_agent);
end

local function Scholomance_Gandling_FindTrappedEntity_SearchList(list, wp, result, bTracked)
	
	local bFound = false;
	for i,ai in ipairs(list) do
		
		local agent = ai.GetPlayer and ai:GetPlayer() or ai;
		local x,y,z = agent:GetPosition();
		if (z < wp[3] + wp.zr and z > wp[3] - wp.zr) then
			local agentD = agent:GetDistance(wp[1], wp[2], wp[3]);
			if (agentD < wp.maxd and agentD < result.d) then
				result.d = agentD;
				result.agent = agent;
				bFound = true;
				-- Print(z, wp[3] + wp.zr, wp[3] - wp.zr, agentD);
				if (bTracked) then
					table.insert(result.tracked, i);
				end
			end
		end
		
	end
	return bFound;
	
end

local function Scholomance_Gandling_FindTrappedEntity(agents, tracked, wp)
	
	local result = {d = 5000.0, tracked = {}};
	Scholomance_Gandling_FindTrappedEntity_SearchList(agents,  wp, result);
	-- Scholomance_Gandling_FindTrappedEntity_SearchList(tracked, wp, result, true);
	-- remove tracked
	for i = 1,#result.tracked do
		table.remove(tracked, result.tracked[i]);
	end
	return result.agent;
	
end

function Scholomance.Gandling:Update(hive, data)

local NPC_RISEN_GUARDIAN      = 11598;
local NPC_DARKMASTER_GANDLING =  1853;

	local player = data.owner or (data.agents[1] and data.agents[1]:GetPlayer());
	if (not player) then return; end
	
	local Guids = Scholomance.encounters.Ids;
	local t_gates = {
		{guid = Guids.DoorKrastinov, wp = {184.599, -100.714, 85.2283, zr= 6, maxd=75}, go = {181.635, -59.0365, 84.8408}, jmp = {181.342, -24.320, 88.9997, 1.563}};
		{guid = Guids.DoorPolkelt  , wp = {280.950, 0.594045, 85.2283, zr= 6, maxd=75}, go = {233.065, -0.09367, 84.8408}, jmp = {204.582, 0.17934, 88.9991, 3.163}};
		{guid = Guids.DoorMalicia  , wp = {80.1259, -1.71220, 85.2283, zr= 6, maxd=75}, go = {128.166, -0.86090, 85.3764}, jmp = {157.361, -0.4550, 89.0072, 0.074}};
		{guid = Guids.DoorIllucia  , wp = {272.899, 1.174460, 75.2500, zr=10, maxd=75}, go = {218.889, -0.15605, 72.6718}, jmp = {200.379, -0.0169, 75.5628, 0.000}};
		{guid = Guids.DoorAlexei   , wp = {178.143, -93.6909, 70.7734, zr=10, maxd=75}, go = {181.516, -42.3059, 75.3978}, jmp = {181.131, -18.826, 75.5544, 0.000}};
	    {guid = Guids.DoorRavenian , wp = {89.0735, -2.85840, 72.7681, zr=10, maxd=75}, go = {146.388, -1.34314, 75.3978}, jmp = {162.585, -0.8611, 75.5534, 0.000}};
	};
	
	local t_trappedAgents = {};
	local bAnyTrapped    = false;
	local bIsTankTrapped = false;
	local bIsHealTrapped = false;
	for i = 1,#t_gates do
		local gate = t_gates[i];
		-- Print(GetObjectGOState(player, gate.guid), i);
		if (GetObjectGOState(player, gate.guid) == 1) then
			local trappedagent = Scholomance_Gandling_FindTrappedEntity(data.agents, data.tracked, gate.wp);
			if (trappedagent) then
				local ai = trappedagent:GetAI();
				local role = ai and Encounter_GetRealRole(ai, self.key) or trappedagent:GetRole();
				if (role == ROLE_TANK) then
					bIsTankTrapped = true;
				elseif (role == ROLE_HEALER) then
					bIsHealTrapped = true;
				end
				-- only units we have control over
				if (ai) then
					t_trappedAgents[trappedagent:GetId()] = i;
					bAnyTrapped = true;
				else
					-- have to clear non agents every time
					AI_IsolateAgent(trappedagent, hive, data.agents);
				end
				
				-- Print(trappedagent:GetName(), "is trapped behind door", gate.guid, i);
			end
		end
	end
	
	local t_guardians = {};
	local uGandling, uGandlingTarget, uGandlingMana;
	for i = #data.attackers,1,-1 do
		local target = data.attackers[i];
		if (target:GetEntry() == NPC_DARKMASTER_GANDLING) then
			uGandling       = target;
			uGandlingTarget = target:GetVictim();
			uGandlingMana   = target:GetPower(POWER_MANA);
		elseif (target:GetEntry() == NPC_RISEN_GUARDIAN) then
			table.remove(data.attackers, i);
			table.insert(t_guardians, target);
		end
	end
	
	local TrappedAI  = Script_GetScholomanceTrappedAI();
	local ManaBurnAI = Script_GetScholomanceManaBurnAI();
	local KiteAI     = Script_GetScholomanceKiteAI();
	
	data.ScholoGandling_IsAnyAgentHurt = false;
	for i,ai in ipairs(data.agents) do
		if (ai:GetPlayer():GetHealthPct() < ManaBurnAI.partyHpThresh) then
			data.ScholoGandling_IsAnyAgentHurt = true;
			break;
		end
	end
	if (not bAnyAgentHurt) then
		for i,unit in ipairs(data.tracked) do
			if (unit:GetHealthPct() < ManaBurnAI.partyHpThresh) then
				data.ScholoGandling_IsAnyAgentHurt = true;
				break;
			end
		end
	end
	
	for i = #data.agents,1,-1 do
		
		local ai = data.agents[i];
		local aidata = ai:GetData();
		local agent  = ai:GetPlayer();
		local iDoorIdx = t_trappedAgents[agent:GetId()];
		local bIsTrappedAI = Data_IsAgentRunningScript(ai, aidata, TrappedAI.name);
		local bIncapacitated = AI_IsIncapacitated(agent);
		
		if (not bIncapacitated or iDoorIdx) then
			
			-- all others are guaranteed to have "bIncapacitated == false" true
			if (iDoorIdx or bIsTrappedAI) then
				
				-- handle trapped ai
				if (not bIncapacitated) then
				
					if (not bIsTrappedAI) then
						TrappedAI.Possess(hive, ai, data, self.key, t_gates[iDoorIdx], 83.0, NPC_RISEN_GUARDIAN, NPC_DARKMASTER_GANDLING);
					elseif (iDoorIdx) then
						if (TrappedAI.GetDoorGuid(ai, aidata) ~= t_gates[iDoorIdx].guid or TrappedAI.HasDoorBeenOpened(ai, aidata)) then
							Command_Complete(ai, "Scholomance_TrappedAI: agent door has changed");
							Print("Scholomance_TrappedAI: door changed for", agent:GetName());
						end
					end
					
				end
				table.remove(data.agents, i);
			
			elseif (uGandling and agent == uGandlingTarget and Encounter_GetRealRole(ai, self.key) ~= ROLE_TANK) then
				
				-- handle kite ai
				if (not Data_IsAgentRunningScript(ai, aidata, KiteAI.name)) then
					KiteAI.Possess(hive, ai, self.key, uGandling:GetGuid());
				end
				
			elseif (uGandlingMana and not data.ScholoGandling_IsAnyAgentHurt and agent:GetClass() == CLASS_PRIEST and uGandlingMana > ManaBurnAI.manaThresh) then
				
				-- handle mana burn ai
				if (not Data_IsAgentRunningScript(ai, aidata, ManaBurnAI.name)) then
					ManaBurnAI.Possess(hive, ai, self.key, aidata.manaburn or 10876, uGandling:GetGuid());
				end
				
			end
			
		end
		
	end
	
	if (bIsTankTrapped) then
		data.attackers.ignoreThreat = true;
	end
	
end

Scholomance.encounters = {
	{name = "Blood Steward of Kirtonos"},
	{name = "Kirtonos the Herald", tpos = {298.999, 93.019, 105.636}, tanko = 3.21},
	{name = "Jandice Barov"},
	{
		name      = "Vectus",
		enemyPrio = {[10432] = 1}, -- kill Vectus first
		tpos      = {120.922, 106.007, 101.431},
		rchrpos   = {x = 145.112, y = 102.628, z = 104.580, melee="dance"},
		tankPot   = 17543,
		script    = Scholomance.Vectus,
	},
	{
		name         = "Ras Frostwhisper",
		tpos         = {-17.562, 141.749, 83.901},
		rchrpos      = {x = 4.239, y = 143.290, z = 83.901, melee="dance"},
		healmax      = true,
		dispelFilter = function()return false;end,
	},
	{name = "Kormok", script = Scholomance.Kormok},
	{name = "Instructor Malicia"},
	{
		name = "Doctor Theolen Krastinov",
		tpos    = {182.122, -79.628, 84.841},
		rchrpos = {x = 184.169, y = -77.858, z = 84.841, melee="ignore"},
		healmax = true,
		selfdef = true,
	},
	{name = "Lorekeeper Polkelt", tpos = {275.126,1.384,85.228}, rchrpos = {x=248.301,y=-3.993,z=84.841,melee="ignore"}, script = Scholomance.Lorekeeper},
	{name = "The Ravenian", tpos = {137.950, 9.238, 75.398}, rchrpos = {x = 138.980, y = -12.864, z = 75.398,melee="ignore"}, tanko=1.597, healmax=true},
	{
		name          = "Lord Alexei Barov",
		allowHealerCc = true,
		script        = Scholomance.Alexei,
		tpos          = {180.898, -9.011, 75.505},
		rchrpos       = {x = 180.047, y = 20.508, z = 89.010,melee="dance"},
		defensepot    = 17548, -- Greater Shadow Protection
	},
	{name = "Lady Illucia Barov"},
	{name = "Darkmaster Gandling", script = Scholomance.Gandling, --[[tpos = {181.599, -5.5427, 75.4875},]] tankPot=17549, defensepot=17549, healmax=true},
	{
		name               = "Global",
		test               = function() return true; end,
		script             = Scholomance.Global,
		UseLosBreakForPull = true,
		useForcedCc        = true,
		noboss             = true,
		enemyPrio = {
			[NPC_SPECTRAL_RESEARCHER] = 1,
		},
	},
	OnLoad = Scholomance_OnLoad,
	Ids =
	{
		StudentDoor   = nil, -- 1: closed, 0: open
		DoorKrastinov = nil,
		DoorPolkelt   = nil,
		DoorMalicia   = nil,
		DoorIllucia   = nil,
		DoorAlexei    = nil,
		DoorRavenian  = nil,
	},
};

Scholomance.encounters.LosTbl    = _losTbl;
Scholomance.encounters.AreaTbl   = _areaTbl;
Scholomance.encounters.RangedTbl = NPC_RANGED_LIST;
