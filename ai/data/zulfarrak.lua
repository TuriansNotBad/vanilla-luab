-- When moving from stairs to hydromancer best avoid pulling from the pathway

t_dungeons[209] = {
	-- Line 1: To intersection
	{
		{1216.42, 840.779, 8.9488, -1000, 2}, -- 1
		{1285.99, 827.704, 8.88557, -1000, 2}, -- 2
		{1314.13, 836.386, 8.89218, -1000, 2}, -- 3
		{1348.69, 820.422, 8.89095, -1000, 2}, -- 4
		{1422.82, 809.372, 8.94706, -1000, 2}, -- 5
		{1505.6, 834.073, 8.89088, -1000, 2}, -- 6
		{1537.24, 831.933, 8.89121, -1000, 2}, -- 7
		{1564.29, 849.347, 8.89121, -1000, 2}, -- 8
	},
	-- Line 2: Left path to Velratha courtyard
	{
		{1576.22, 859.261, 8.8921, -1000, 2}, -- 1
		{1635.54, 893.871, 9.39434, -1000, 2}, -- 2
		{1661.44, 920.883, 8.87689, -1000, 2}, -- 3
		{1603.77, 975.413, 8.9446, -1000, 2}, -- 4
		{1567.45, 1007.96, 8.87831, -1000, 2}, -- 5
		{1582.13, 1083.99, 8.87754, -1000, 2}, -- 6
		{1607.95, 1114.37, 8.87683, -1000, 2}, -- 7
	},
	-- Line 3: Velratha courtyard lhs
	{
		{1612.56, 1118.12, 8.87683, -1000, 2}, -- 1
		{1635.79, 1150.93, 8.87683, -1000, 2}, -- 2
		{1631.84, 1186.35, 8.93542, -1000, 2}, -- 3
		{1721.1, 1281.5, 14.1286, -1000, 2}, -- 4
	},
	-- Line 4: Velratha courtyard rhs
	{
		{1614.74, 1116.06, 8.87796, -1000, 2}, -- 1
		{1638.1, 1144.43, 8.878, -1000, 2}, -- 2
		{1659.98, 1146.06, 8.87792, -1000, 2}, -- 3
		{1709.08, 1195.51, 9.19788, -1000, 2}, -- 4
		{1731.14, 1274.72, 13.6691, -1000, 2}, -- 5
	},
	-- Line 5: From Velratha courtyard to big staircase
	{
		{1706.32, 1161.27, 8.98663, -1000, 2}, -- 1
		{1726.28, 1144.23, 9.03146, -1000, 2}, -- 2
		{1787.53, 1143.83, 8.98751, -1000, 2}, -- 3
		{1829.88, 1183.7, 8.98778, -1000, 2}, -- 4
		{1874.72, 1223.18, 9.34056, -1000, 2}, -- 5
	},
	-- Line 6: Up the staircase
	{
		{1886.64, 1232.53, 12.7031, -1000, 2}, -- 1
		{1886.39, 1261.61, 41.1697, -1000, 2}, -- 2
		{1885.56, 1292.29, 46.0722, -1000, 2}, -- 3
	},
	-- Line 7: To chief's room
	{
		{1843.19, 1133.29, 20.6738, -1000, 2}, -- 1
		{1781.34, 1079.08, 42.6957, -1000, 2}, -- 2
	},
	-- Line 8: Chief lhs
	{
		{1779.62, 1076.3, 43.4129, -1000, 2}, -- 1
		{1759, 1054.58, 47.7001, -1000, 2}, -- 2
		{1776.24, 1035.73, 53.4297, -1000, 2}, -- 3
		{1757.65, 1010.59, 53.4867, -1000, 2}, -- 4
	},
	-- Line 9: Chief rhs
	{
		{1778.03, 1079.03, 43.1429, -1000, 2}, -- 1
		{1757.1, 1060.43, 47.707, -1000, 2}, -- 2
		{1742.05, 1071.3, 52.7512, -1000, 2}, -- 3
		{1731.91, 1070.18, 53.4781, -1000, 2}, -- 4
		{1715.65, 1047.38, 53.4881, -1000, 2}, -- 5
	},
	-- Line 10: To scarab courtyard
	{
		{1578.34, 855.567, 8.98041, -1000, 2}, -- 1
		{1641.49, 884.146, 8.89151, -1000, 2}, -- 2
		{1690.87, 901.368, 8.87683, -1000, 2}, -- 3
		{1677.96, 843.745, 8.87746, -1000, 2}, -- 4
		{1654.58, 808.874, 8.87696, -1000, 2}, -- 5
		{1688.22, 804.654, 8.88121, -1000, 2}, -- 6
		{1707.92, 811.854, 8.8769, -1000, 2}, -- 7
	},
	-- Line 11: Up the mountain before scarab courtyard
	{
		{1649, 765.21, 15.4525, -1000, 2}, -- 1
		{1656.54, 741.693, 20.1967, -1000, 2}, -- 2
		{1655.58, 723.389, 25.9213, -1000, 2}, -- 3
		{1652.86, 708.561, 30.5925, -1000, 2}, -- 4
	},
	-- Line 12: Scarab courtyard lhs
	{
		{1711.19, 815.129, 8.87739, -1000, 2}, -- 1
		{1744.55, 834.251, 8.87731, -1000, 2}, -- 2
		{1769.52, 861.822, 8.87731, -1000, 2}, -- 3
		{1808.03, 902.528, 8.89536, -1000, 2}, -- 4
	},
	-- Line 13: Scarab courtyard rhs
	{
		{1714.65, 811.452, 8.87685, -1000, 2}, -- 1
		{1747.67, 831.241, 8.87683, -1000, 2}, -- 2
		{1773.42, 855.562, 8.90295, -1000, 2}, -- 3
		{1811.05, 841.741, 8.87684, -1000, 2}, -- 4
		{1824.08, 872.866, 8.87684, -1000, 2}, -- 5
		{1818.25, 894.842, 8.87684, -1000, 2}, -- 6
	},
	-- Line 14: Scarab courtyard short mountain dead end
	{
		{1827.73, 813.206, 13.8534, -1000, 2}, -- 1
		{1860.9, 851.883, 20.534, -1000, 2}, -- 2
	},
	-- Line 15: From Scarab courtyard to Antu'sul
	{
		{1805.81, 808.478, 13.1641, -1000, 2}, -- 1
		{1792.38, 764.139, 14.0839, -1000, 2}, -- 2
		{1812.6, 713.427, 14.5583, -1000, 2}, -- 3
		{1811.54, 676.036, 14.1399, -1000, 2}, -- 4
	},
	-- Line 16: Mountain rhs near Antu'sul
	{
		{1782.06, 740.328, 15.9583, -1000, 2}, -- 1
		{1739.35, 707.122, 24.5474, -1000, 2}, -- 2
	},
	-- Line 17: Mountain lhs near Antu'sul
	{
		{1824.83, 734.105, 17.1843, -1000, 2}, -- 1
		{1856.93, 725.666, 19.8347, -1000, 2}, -- 2
		{1883.88, 727.481, 32.3913, -1000, 2}, -- 3
	},
	-- Line 18: From scarab courtyard to big staircase
	{
		{1820.06, 910.132, 8.89155, -1000, 2}, -- 1
		{1863.44, 977.706, 8.88202, -1000, 2}, -- 2
		{1882.12, 1004.63, 8.8769, -1000, 2}, -- 3
		{1851.26, 1056.01, 8.8769, -1000, 2}, -- 4
		{1890.1, 1140.02, 9.00522, -1000, 2}, -- 5
		{1903.14, 1177.08, 8.89534, -1000, 2}, -- 6
		{1895.9, 1224.21, 9.28964, -1000, 2}, -- 7
	},
};

local Zulfarrak = t_dungeons[209];

local function Zulfarrak_OnLoad(self, hive, data, player)
	
-- Entries
local NPC_BLY = 7604;
	
	Print("Zulfarrak_OnLoad: initialized by player", player:GetName(), "; Guid:", tostring(player:GetGuid()), player:GetMapId());

	-- find bly
	local x,y,z,r = Zulfarrak.Bly.Pos.x, Zulfarrak.Bly.Pos.y, Zulfarrak.Bly.Pos.z, 100.0;
	local bly = GetUnitsWithEntryNear(player, NPC_BLY, x, y, z, r, false, false)[1];
	if (not bly) then
		Print("Failed to find Blastmaster at coords = (", x, y, z, ") with radius =", r, "entry =", NPC_BLY);
		error("Zulfarrak_OnLoad: Bly not found in map. Entry = " .. tostring(NPC_BLY));
	end
	self.Ids.Bly = bly:GetGuid();
	
end


local function Shadowhunter_Update(self, hive, data)
	
local NPC_SHADOWHUNTER = 7246;

	for i,target in ipairs(data.attackers) do
		if (target:GetEntry() == NPC_SHADOWHUNTER) then
			table.insert(data.forcedCc, target);
		end
	end
	
end

Zulfarrak.Bly = 
{
	Pos = {x = 1882.890, y =1299.270, z = 48.384};
};

function Zulfarrak.Bly.Test(hive, data)
	
	local player = data.owner or (data.agents[1] and data.agents[1]:GetPlayer());
	if (player) then
		local bly = GetUnitByGuid(player, Zulfarrak.encounters.Ids.Bly);
		if (bly) then
			return bly:GetDistance(player) < 50.0 and bly:GetDistance(Zulfarrak.Bly.Pos.x, Zulfarrak.Bly.Pos.y, Zulfarrak.Bly.Pos.z) > 5.0;
		end
	end
	return false;
	
end

function Zulfarrak.Bly.Update(self, hive, data)
	
	local bly;
	local player = data.owner or (data.agents[1] and data.agents[1]:GetPlayer());
	if (player) then
		bly = GetUnitByGuid(player, Zulfarrak.encounters.Ids.Bly);
	end
	
	if (not bly) then return; end
	
	for i = #data.attackers,1,-1 do
		local target = data.attackers[i];
		if (target:GetDistance(bly) > 30.0) then
			table.remove(data.attackers, i);
		end
	end
	
end

Zulfarrak.encounters = {
	{name = "Antu'sul"},
	{name = "Theka the Martyr"},
	{name = "Witch Doctor Zum'rah"},
	{name = "Nekrum Gutchewer"},
	{name = "Stairs Encounter", script = Zulfarrak.Bly, test = Zulfarrak.Bly.Test},
	{name = "Sergeant Bly"},
	{name = "Chief Ukorz Sandscalp"},
	{name = "Gahz'rilla"},
	{name = "Sandfury Shadowhunter", useForcedCc = true, script = {Update = Shadowhunter_Update}},
	OnLoad = Zulfarrak_OnLoad,
	Ids =
	{
		Bly = nil,
	},
};
