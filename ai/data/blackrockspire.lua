-----------------------------------------------------------------------------------------------
-- A lot of issues with pull direction in Anvilcrack's area

t_dungeons[229] = {
	-- Line 1
	{
		{79.188, -239.160, 55.278, -1000, 2}, -- 1
		{79.9122, -248.707, 60.4937, -1000, 2}, -- 2
		{82.0257, -274.48, 60.6836, -1000, 2}, -- 3
		{95.2688, -297.119, 60.7021, -1000, 2}, -- 4
		{95.6397, -311.372, 65.4635, -1000, 2}, -- 5
		{95.8623, -317.932, 65.4635, -1000, 2}, -- 6
		{112.017, -318.835, 65.4617, -1000, 2}, -- 7
		{120.331, -319.024, 70.9541, -1000, 2}, -- 8
		{170.702, -318.481, 70.9552, -1000, 2}, -- 9
		{184.398, -317.007, 76.9125, -1000, 2}, -- 10
		{212.714, -286.676, 76.9465, -1000, 2}, -- 11
		{225.733, -286.792, 76.9853, -1000, 2}, -- 12
		{225.607, -275.86, 77.0579, -1000, 2}, -- 13
		{225.783, -267.338, 82.0958, -1000, 2}, -- 14
		{223.579, -258.333, 82.1305, -1000, 2}, -- 15
		{212.221, -258.786, 82.089, -1000, 2}, -- 16
		{196.681, -258.87, 91.5452, -1000, 2}, -- 17
		{157.828, -258.797, 91.5502, -1000, 2}, -- 18
		{155.91, -274.143, 91.5855, -1000, 2}, -- 19
		{131.197, -273.627, 91.5529, -1000, 2}, -- 20
		{126.155, -258.52, 91.5531, -1000, 2}, -- 21
		{114.771, -258.798, 91.5482, -1000, 2}, -- 22
		{81.175, -261.133, 91.4714, -1000, 2}, -- 23
		{58.4813, -254.409, 96.8586, -1000, 2}, -- 24
		{59.4912, -242.847, 97.9419, -1000, 2}, -- 25
		{68.434, -242.415, 98.5216, -1000, 2}, -- 26
		{89.4157, -241.57, 105.517, -1000, 2}, -- 27
		{101.635, -242.402, 106.436, -1000, 2}, -- 28
		{100.275, -333.89, 106.436, -1000, 2}, -- 29
	},
	-- Line 2
	{
		{106.813, -241.598, 106.436, -1000, 2}, -- 1
		{107.864, -256.652, 106.436, -1000, 2}, -- 2
		{116.03, -258.147, 106.627, -1000, 2}, -- 3
		{123.858, -258.933, 110.951, -1000, 2}, -- 4
		{162.603, -258.213, 110.897, -1000, 2}, -- 5
	},
	-- Line 3
	{
		{108.162, -242.658, 106.436, -1000, 2}, -- 1
		{108.585, -256.565, 106.436, -1000, 2}, -- 2
		{116.101, -259.919, 106.673, -1000, 2}, -- 3
		{124.47, -261.549, 110.949, -1000, 2}, -- 4
		{138.779, -264.68, 110.911, -1000, 2}, -- 5
		{152.124, -272.156, 110.943, -1000, 2}, -- 6
		{158.083, -304.547, 110.651, -1000, 2}, -- 7
	},
	-- Line 4
	{
		{104.05, -322.925, 106.436, -1000, 2}, -- 1
		{109.878, -312.716, 106.436, -1000, 2}, -- 2
		{123.865, -312.567, 110.95, -1000, 2}, -- 3
		{141.998, -318.804, 110.946, -1000, 2}, -- 4
		{138.126, -349.174, 110.97, -1000, 2}, -- 5
		{136.589, -358.641, 116.838, -1000, 2}, -- 6
		{137.145, -374.723, 116.807, -1000, 2}, -- 7
		{137.63, -383.892, 121.975, -1000, 2}, -- 8
		{142.235, -393.821, 121.975, -1000, 2}, -- 9
	},
	-- Line 5
	{
		{107.17, -300.575, 106.436, -1000, 2}, -- 1
		{111.319, -311.744, 106.436, -1000, 2}, -- 2
		{124.736, -313.703, 110.949, -1000, 2}, -- 3
		{148.936, -321.964, 110.845, -1000, 2}, -- 4
		{165.451, -347.77, 110.97, -1000, 2}, -- 5
		{165.62, -359.141, 116.837, -1000, 2}, -- 6
		{165.632, -375.421, 116.932, -1000, 2}, -- 7
		{165.995, -383.551, 121.975, -1000, 2}, -- 8
		{164.972, -394.055, 121.975, -1000, 2}, -- 9
	},
	-- Line 6
	{
		{131.085, -366.173, 116.841, -1000, 2}, -- 1
		{90.7734, -364.557, 117.775, -1000, 2}, -- 2
		{92.5975, -384.923, 116.842, -1000, 2}, -- 3
		{93.1563, -402.26, 110.923, -1000, 2}, -- 4
		{92.5967, -439.34, 110.923, -1000, 2}, -- 5
		{92.7212, -455.747, 116.842, -1000, 2}, -- 6
		{93.2392, -474.434, 116.842, -1000, 2}, -- 7
		{74.6343, -474.619, 116.842, -1000, 2}, -- 8
		{51.8844, -474.699, 110.923, -1000, 2}, -- 9
		{40.8426, -475.551, 110.94, -1000, 2}, -- 10
		{33.157, -446.404, 110.954, -1000, 2}, -- 11
		{33.9334, -369.701, 110.695, -1000, 2}, -- 12
		{29.7516, -339.527, 110.943, -1000, 2}, -- 13
		{14.1359, -309.665, 110.947, -1000, 2}, -- 14
		{6.14695, -262.514, 110.944, -1000, 2}, -- 15
	},
	-- Line 7
	{
		{74.9807, -475.876, 116.842, -1000, 2}, -- 1
		{50.4982, -476.374, 110.921, -1000, 2}, -- 2
		{26.5722, -499.199, 110.952, -1000, 2}, -- 3
		{27.2138, -524.811, 110.942, -1000, 2}, -- 4
		{86.231, -550.532, 110.925, -1000, 2}, -- 5
	},
	-- Line 8
	{
		{94.6147, -439.009, 110.923, -1000, 2}, -- 1
		{94.4442, -456.904, 116.842, -1000, 2}, -- 2
		{96.9216, -472.82, 116.842, -1000, 2}, -- 3
		{166.734, -474.241, 116.842, -1000, 2}, -- 4
		{164.257, -447.689, 121.975, -1000, 2}, -- 5
	},
	-- Line 9
	{
		{134.681, -448.457, 121.975, -1000, 2}, -- 1
		{155.818, -446.704, 121.975, -1000, 2}, -- 2
	},
	-- Line 10
	{
		{111.736, -420.198, 110.89, -1000, 2}, -- 1
		{186.579, -421.532, 110.875, -1000, 2}, -- 2
	},
	-- LBRS
	-- Line 11 entrance straight
	{
		{76.8738, -228.542, 49.6712, -1000, 2}, -- 1
		{78.9376, -249.004, 60.5018, -1000, 2}, -- 2
		{80.4647, -297.273, 60.7007, -1000, 2}, -- 3
		{81.2881, -331.813, 55.786, -1000, 2}, -- 4
		{81.3617, -341.705, 60.702, -1000, 2}, -- 5
		{80.8517, -356.09, 60.702, -1000, 2}, -- 6
	},
	-- Line 12 entrance right stair
	{
		{76.3999, -227.966, 49.7081, -1000, 2}, -- 1
		{78.5115, -249.945, 60.5321, -1000, 2}, -- 2
		{78.7746, -263.282, 60.7017, -1000, 2}, -- 3
		{64.8304, -296.513, 60.6996, -1000, 2}, -- 4
		{63.8816, -312.009, 65.4635, -1000, 2}, -- 5
		{65.7116, -342.556, 60.702, -1000, 2}, -- 6
	},
	-- Line 13 up to the dead end lbrs entrance
	{
		{59.8345, -325.41, 53.9152, -1000, 2}, -- 1
		{38.8275, -326.149, 53.7374, -1000, 2}, -- 2
		{42.377, -288.756, 65.3758, -1000, 2}, -- 3
		{16.4423, -286.684, 65.3758, -1000, 2}, -- 4
		{15.7165, -257.603, 65.3566, -1000, 2}, -- 5
	},
	-- Line 14 from lbrs entrance to omokk
	{
		{58.8692, -326.358, 53.9164, -1000, 2}, -- 1
		{18.106, -330.862, 48.7182, -1000, 2}, -- 2
		{18.4739, -348.355, 48.6719, -1000, 2}, -- 3
		{35.9561, -349.142, 48.6777, -1000, 2}, -- 4
		{44.3902, -404.93, 48.773, -1000, 2}, -- 5
		{61.9904, -417.74, 45.1049, -1000, 2}, -- 6
		{85.9302, -468.744, 34.3098, -1000, 2}, -- 7
		{79.7923, -487.548, 27.8183, -1000, 2}, -- 8
		{47.2954, -493.99, 29.4204, -1000, 2}, -- 9
		{50.3993, -515.702, 30.0029, -1000, 2}, -- 10
		{52.3263, -580.138, 30.6002, -1000, 2}, -- 11
		{-33.6796, -576.956, 29.1909, -1000, 2}, -- 12
		{-53.6845, -540.206, 29.1909, -1000, 2}, -- 13
		{-36.97, -494.638, 29.1303, -1000, 2}, -- 14
		{-36.9939, -416.612, 31.5776, -1000, 2}, -- 15
		{-37.4783, -365.644, 31.6186, -1000, 2}, -- 16
		{-20.1787, -332.023, 31.585, -1000, 2}, -- 17
		{-21.9601, -299.485, 31.6168, -1000, 2}, -- 18
	},
	-- Line 15 omokk to voshgajin
	{
		{2.27334, -524.09, 29.3487, -1000, 2}, -- 1
		{2.30302, -494.366, 29.0126, -1000, 2}, -- 2
		{0.0383401, -461.365, 16.0967, -1000, 2}, -- 3
		{-33.5505, -459.793, 16.4302, -1000, 2}, -- 4
		{-62.941, -480.795, 16.2584, -1000, 2}, -- 5
		{-81.9636, -481.084, 24.2252, -1000, 2}, -- 6
		{-121.657, -482.122, 24.5253, -1000, 2}, -- 7
	},
	-- Line 16 omokk to bijou
	{
		{0.107361, -523.237, 29.2848, -1000, 2}, -- 1
		{0.781099, -495.249, 29.0113, -1000, 2}, -- 2
		{-1.6329, -461.475, 16.1257, -1000, 2}, -- 3
		{-23.7643, -461.309, 16.4941, -1000, 2}, -- 4
		{-40.8249, -483.83, 16.2944, -1000, 2}, -- 5
		{-40.5488, -495.187, 16.1634, -1000, 2}, -- 6
		{-38.9538, -549.594, 16.1267, -1000, 2}, -- 7
		{-26.0145, -553.452, 16.1229, -1000, 2}, -- 8
		{-8.77314, -545.46, 16.2104, -1000, 2}, -- 9
	},
	-- Line 17 omokk to orc caves
	{
		{-1.19979, -523.127, 29.2462, -1000, 2}, -- 1
		{-0.368008, -495.393, 29.011, -1000, 2}, -- 2
		{-2.15658, -461.641, 16.1363, -1000, 2}, -- 3
		{-29.3651, -465.281, 16.4292, -1000, 2}, -- 4
		{-38.7417, -495.538, 16.0062, -1000, 2}, -- 5
		{-45.7949, -518.768, 4.50925, -1000, 2}, -- 6
		{-72.9125, -519.259, -7.14288, -1000, 2}, -- 7
		{-72.9214, -571.949, -18.8524, -1000, 2}, -- 8
		{15.9584, -575.563, -18.6015, -1000, 2}, -- 9
	},
	-- Line 18 omokk to left side of large room next to voone
	{
		{3.86103, -522.497, 29.399, -1000, 2}, -- 1
		{3.35982, -490.823, 27.4362, -1000, 2}, -- 2
		{0.613947, -461.917, 16.0859, -1000, 2}, -- 3
		{-26.9563, -462.407, 16.4507, -1000, 2}, -- 4
		{-38.3865, -494.736, 16.1695, -1000, 2}, -- 5
		{-46.067, -517.338, 4.50922, -1000, 2}, -- 6
		{-73.6843, -514.4, -7.14286, -1000, 2}, -- 7
		{-72.5441, -480.348, -18.7643, -1000, 2}, -- 8
		{-4.10178, -479.916, -18.7917, -1000, 2}, -- 9
		{-4.3467, -511.94, -7.14289, -1000, 2}, -- 10
		{-4.42391, -522.888, -7.14289, -1000, 2}, -- 11
		{-5.38064, -565.046, -18.7606, -1000, 2}, -- 12
	},
	-- Line 19 middle of large room next to voone
	{
		{-62.6368, -538.973, -18.8003, -1000, 2}, -- 1
		{-61.12, -516.965, -18.8111, -1000, 2}, -- 2
		{-34.6959, -518.206, -18.8109, -1000, 2}, -- 3
	},
	-- Line 20 voone los pull
	{
		{-75.9061, -473.546, -18.7478, -1000, 2}, -- 1
		{-60.6741, -471.824, -18.7436, -1000, 2}, -- 2
		{-60.4723, -458.563, -18.6443, -1000, 2}, -- 3
		{-43.5376, -456.379, -18.6443, -1000, 2}, -- 4
		{-30.9159, -451.001, -18.6443, -1000, 2}, -- 5
		{-13.3096, -459.319, -18.6443, -1000, 2}, -- 6
	},
	-- Line 21 thru hordemar to dead end
	{
		{23.8862, -568.469, -18.6015, -1000, 2}, -- 1
		{25.3318, -552.68, -18.6015, -1000, 2}, -- 2
		{33.3216, -551.936, -18.6015, -1000, 2}, -- 3
		{30.4219, -532.908, -18.6015, -1000, 2}, -- 4
		{32.1451, -526.844, -18.6015, -1000, 2}, -- 5
		{22.5356, -512.762, -18.5913, -1000, 2}, -- 6
		{14.4489, -507.392, -18.4045, -1000, 2}, -- 7
		{21.1725, -447.68, -18.935, -1000, 2}, -- 8
		{3.20574, -445.053, -18.935, -1000, 2}, -- 9
		{-12.0239, -418.494, -18.935, -1000, 2}, -- 10
		{-64.5074, -418.342, -18.935, -1000, 2}, -- 11
		{-109.024, -461.665, -18.935, -1000, 2}, -- 12
		{-116.116, -494.96, -18.4564, -1000, 2}, -- 13
		{-150.704, -503.247, -18.4564, -1000, 2}, -- 14
	},
	-- Line 22 dead end to spider boss nook
	{
		{-112.565, -501.587, -17.3, -1000, 2}, -- 1
		{-110.897, -557.522, 5.71502, -1000, 2}, -- 2
		{-123.576, -570.409, 12.7409, -1000, 2}, -- 3
		{-133.709, -564.786, 10.4957, -1000, 2}, -- 4
		{-138.474, -532.317, 6.69169, -1000, 2}, -- 5
	},
	-- Line 23 dead end to scorpion pit
	{
		{-109.247, -502.579, -17.2554, -1000, 2}, -- 1
		{-117.003, -573.359, 11.7577, -1000, 2}, -- 2
		{-125.51, -562.973, 11.3653, -1000, 2}, -- 3
		{-128.067, -491.12, 11.9901, -1000, 2}, -- 4
		{-140.362, -482.381, 11.9308, -1000, 2}, -- 5
		{-140.934, -470.591, 14.8783, -1000, 2}, -- 6
		{-142.385, -461.65, 15.6279, -1000, 2}, -- 7
		{-146.379, -455.633, 17.7529, -1000, 2}, -- 8
		{-135.014, -441.536, 22.4037, -1000, 2}, -- 9
		{-135.053, -434.543, 22.941, -1000, 2}, -- 10
		{-123.056, -417.446, 29.4866, -1000, 2}, -- 11
		{-116.661, -407.661, 30.8736, -1000, 2}, -- 12
		{-56.9519, -392.532, 46.0307, -1000, 2}, -- 13
		{-47.6648, -385.004, 49.4332, -1000, 2}, -- 14
		{-9.394, -400.185, 48.517, -1000, 2}, -- 15
		{-33.2384, -368.525, 50.5201, -1000, 2}, -- 16
		{-70.0007, -366.544, 54.2618, -1000, 2}, -- 17
		{-80.6999, -303.435, 60.9044, -1000, 2}, -- 18
	},
	-- Line 24 pit to pit
	{
		{-73.8855, -366.465, 54.5728, -1000, 2}, -- 1
		{-107.242, -367.371, 56.5073, -1000, 2}, -- 2
		{-113.119, -319.05, 64.4473, -1000, 2}, -- 3
	},
	-- Line 25 pit to quartermaster
	{
		{-138.474, -369.784, 57.9933, -1000, 2}, -- 2
		{-164.704, -370.024, 64.4008, -1000, 2}, -- 3
		{-166.739, -404.961, 75.3596, -1000, 2}, -- 4
		{-167.534, -446.953, 87.3902, -1000, 2}, -- 5
		{-172.103, -456.508, 87.3902, -1000, 2}, -- 6
		{-191.009, -459.952, 87.3902, -1000, 2}, -- 7
		{-204.668, -479.997, 87.3902, -1000, 2}, -- 8
	},
	-- Line 26 pit to wolf boss
	{
		{-137.985, -368.308, 57.9934, -1000, 2}, -- 2
		{-164.201, -367.691, 64.4013, -1000, 2}, -- 3
		{-170.167, -326.088, 64.4013, -1000, 2}, -- 4
		{-186.399, -326.694, 64.4242, -1000, 2}, -- 5
		{-192.256, -337.436, 64.4242, -1000, 2}, -- 6
	},
	-- Line 27 pit to last boss
	{
		{-135.353, -368.729, 57.9935, -1000, 2}, -- 2
		{-162.875, -366.756, 64.4008, -1000, 2}, -- 3
		{-161.201, -344.562, 64.4008, -1000, 2}, -- 4
		{-138.042, -343.859, 70.8981, -1000, 2}, -- 5
		{-127.662, -336.269, 70.9524, -1000, 2}, -- 6
		{-118.553, -302.564, 70.9524, -1000, 2}, -- 7
		{-99.7559, -310.691, 70.9524, -1000, 2}, -- 8
		{-69.8642, -320.646, 71.3097, -1000, 2}, -- 9
		{-52.581, -321.03, 70.9676, -1000, 2}, -- 10
		{-52.9732, -373.299, 78.3141, -1000, 2}, -- 11
		{-52.7731, -441.105, 78.2854, -1000, 2}, -- 12
		{-56.4509, -474.329, 77.9144, -1000, 2}, -- 13
		{-80.8393, -494.8, 77.9144, -1000, 2}, -- 14
		{-77.1967, -524.133, 82.3619, -1000, 2}, -- 15
		{-58.3299, -528.592, 84.0819, -1000, 2}, -- 16
		{-47.4607, -513.944, 88.5463, -1000, 2}, -- 17
		{-40.9346, -496.354, 90.5469, -1000, 2}, -- 18
		{-17.4408, -485.641, 90.6957, -1000, 2}, -- 19
	},
};

local BlackrockSpire = t_dungeons[229];
BlackrockSpire.Emberseer = {
	Spellid = 16532,
};

-- remember everyone's roles
function BlackrockSpire.Emberseer:PreprocessAgents(data)
	for i,ai in ipairs(data.agents) do
		local aidata = ai:GetData();
		if (nil == aidata["BlackrockSpire.UBRS.OldRole"]) then
			aidata["BlackrockSpire.UBRS.OldRole"] = ai:GetRole();
		end
	end
end

-- reset everyone's roles
function BlackrockSpire.Emberseer:RestoreAgents(data)
	for i,ai in ipairs(data.agents) do
		local agent = ai:GetPlayer();
		agent:InterruptSpell(CURRENT_CHANNELED_SPELL);
		agent:ClearMotion();
		local aidata = ai:GetData();
		aidata.targets    = nil;
		aidata.attackmode = nil;
		aidata.saveMana   = nil;
		aidata.rchrpos    = nil;
		aidata.forcecurse = nil;
		if (aidata["BlackrockSpire.UBRS.OldRole"]) then
			Command_ClearAll(ai, "BlackrockSpire.UBRS.RestoreAgents");
			ai:SetRole(aidata["BlackrockSpire.UBRS.OldRole"]);
			aidata["BlackrockSpire.UBRS.OldRole"] = nil;
		end
	end
end

function BlackrockSpire.Emberseer:ChangeRole(ai, newRole)
	if (nil == ai:GetData()["BlackrockSpire.UBRS.OldRole"]) then
		error("BlackrockSpire.UBRS.ChangeRole: " .. ai:GetPlayer():GetName() .. " - has no saved role, agent will not function correctly");
	end
	ai:SetRole(newRole);
end

function BlackrockSpire.Emberseer:GetRealRole(ai)
	local data = ai:GetData();
	if (nil == data["BlackrockSpire.UBRS.OldRole"]) then
		error("BlackrockSpire.UBRS.GetRealRole: " .. ai:GetPlayer():GetName() .. " - has no saved role, agent will not function correctly");
	end
	return data["BlackrockSpire.UBRS.OldRole"];
end


function BlackrockSpire.Emberseer.Test(hive, data)
	
	if (not data.owner) then return false; end
	if (data.owner:GetCurrentSpellId(CURRENT_CHANNELED_SPELL) == BlackrockSpire.Emberseer.Spellid) then
		return true;
	end
	return false;
	
end

function BlackrockSpire.Emberseer:Update(hive, data)
	
	if (not data.owner) then
		return;
	end
	
	local pos = {
		{x = 141.548, y = -280.845, z = 91.554},
		{x = 146.593, y = -283.752, z = 91.552},
		altar = 175706,
	};
	
	local posidx = 1;
	for i = 1, #data.agents do
		
		if (posidx > 2) then
			break;
		end
		
		local ai = data.agents[i];
		if (self:GetRealRole(ai) == ROLE_RDPS or self:GetRealRole(ai) == ROLE_MDPS) then
			
			local agent = ai:GetPlayer();
			
			if (ai:GetRole() ~= ROLE_SCRIPT) then
				Command_ClearAll(ai, "BlackrockSpire.Emberseer taking control");
				self:ChangeRole(ai, ROLE_SCRIPT);
			end
			
			local x,y,z = pos[posidx].x, pos[posidx].y, pos[posidx].z;
			if (agent:GetDistance(x,y,z) > 2) then
			
				-- move to the altar
				if (false == ai:IsMovingTo(x,y,z)) then
					agent:ClearMotion();
					agent:MovePoint(x,y,z,false);
				end
			
			else
			
				if (agent:GetMotionType() ~= MOTION_IDLE) then
					agent:ClearMotion();
				end
				
				if (agent:GetCurrentSpellId(CURRENT_CHANNELED_SPELL) ~= self.Spellid) then
					
					local guid = GetObjectsWithEntryAround(agent, pos.altar, 30, false)[1];
					if (not guid) then return; end
					agent:UseObj(guid);
					
				end
			
			end
			
			posidx = posidx + 1;
		
		end
		
	end
end

function BlackrockSpire.Emberseer:OnBegin(hive, data)
	self:PreprocessAgents(data);
end

function BlackrockSpire.Emberseer:OnEnd(hive, data)
	self:RestoreAgents(data);
end

BlackrockSpire.Valthalak = {
	Entry = 16042,
};

function BlackrockSpire.Valthalak:Update(hive, data)

local rposlistfar  =
{
	{x = 40.930, y = -547.554, z = 110.931},
	{x = 40.351, y = -534.694, z = 110.936},
	{x = 99.502, y = -560.083, z = 109.325},
	{x = 62.932, y = -514.674, z = 110.936},
};
local rposlistnear =
{
	{x = 66.772, y = -558.570, z = 110.924},
	{x = 87.494, y = -557.470, z = 110.923},
	{x = 53.709, y = -555.774, z = 110.926},
	{x = 45.637, y = -541.439, z = 110.933},
	{x = 47.039, y = -523.686, z = 110.941},
	{x = 81.600, y = -517.559, z = 113.854},
};

	-- find valthalk and remove ghosts from attacker table
	local valthalak;
	local ghosts = {ignoreThreat = true};
	for i = #data.attackers, 1, -1 do
		local target = data.attackers[i];
		if (target:GetEntry() == self.Entry) then
			valthalak = target;
		else
			table.insert(ghosts, target);
			table.remove(data.attackers, i);
		end
	end
	
	if (nil == valthalak) then return; end
	
	local should_drain = valthalak:GetPowerPct(POWER_MANA) > 5;
	local should_burn  = valthalak:GetHealthPct() <= 15.0;
	-- up to 3 agents kill ghosts, warlocks drain valthalak, tanks and free dps agents only attack valthalak
	local limit = 0;
	for i,ai in ipairs(data.agents) do
		
		local agent = ai:GetPlayer();
		local aidata = ai:GetData();
		if (ai:GetRole() == ROLE_MDPS or ai:GetRole() == ROLE_RDPS) then
			
			if (#ghosts == 0) then
				aidata.targets    = nil;
				aidata.attackmode = nil;
				if (should_burn) then
					aidata.saveMana   = nil;
				end
			else
			
				if (agent:GetClass() == CLASS_WARLOCK and should_drain) then
					aidata.targets = {valthalak, ignoreThreat = true};
					aidata.attackmode = "manadrain";
					aidata.saveMana = 40.0;
				elseif (limit < 3) then
					aidata.targets = ghosts;
					limit = limit + 1;
				else
					aidata.targets    = nil;
					aidata.attackmode = nil;
				end
				
			end
			
		end
		
		-- spread
		local rposlist;
		if (ai:GetRole() == ROLE_RDPS)   then rposlist = rposlistnear; end
		if (ai:GetRole() == ROLE_HEALER) then rposlist = rposlistfar;  end
		if (rposlist) then
			
			aidata.rchrpos = rposlist[#rposlist];
			if (#rposlist > 1) then
				table.remove(rposlist,#rposlist);
			end
			
		end
		
	end
	
end

function BlackrockSpire.Valthalak:OnBegin(hive, data)
	BlackrockSpire.Emberseer:PreprocessAgents(data);
end

function BlackrockSpire.Valthalak:OnEnd(hive, data)
	BlackrockSpire.Emberseer:RestoreAgents(data);
end

t_dungeons[229].encounters = {
	{name = "Emberseer", script = BlackrockSpire.Emberseer, test = BlackrockSpire.Emberseer.Test},
	{name = "The Beast", tpos = {67.137, -538.675, 110.933}, rchrpos = {x = 32.286, y = -542.986, z = 110.933, melee = "dance"}},
	{name = "General Drakkisath", healmax = true, allowFearCc = true},
	{name = "Lord Valthalak", healmax = true, tankswap = true, tpos = {67.137, -538.675, 110.933}, script = BlackrockSpire.Valthalak, defensepot = 17548},
	--lbrs
	{name = "Smolderthorn Witch Doctor", pull = true, summonTotems = {10218}},
	{name = "Highlord Omokk", healmax = true},
	{name = "Shadow Hunter Vosh'gajin"},
	{name = "War Master Voone"},
	{name = "Urok Doomhowl", pull = true, tpos = {-47.509, -364.430, 52.275}, rchrpos = {x = -9.409, y = -369.141, z = 49.705, melee = "ignore"}},
	{name = "Halycon", tpos = {-191.290, -327.733, 64.423}},
	{name = "Overlord Wyrmthalak", tpos = {-80.598, -522.738, 82.635}, tanko = 4.73, rchrpos = {x = -81.188, y = -503.660, z = 79.310, melee = "dance"}},
	
	dispelFilter = function(target, hive, data, agents, friendly)
		-- don't dispel Slow
		if (target:HasAura(13747)) then return false; end
		return nil;
	end
	
};
